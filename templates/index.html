<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#1e1e1e">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<title>FS Randoms Trainer</title>

<style>
:root {
  --gutter: 10px;
  --space-top: 5px;
  --space-bottom: 5px;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  background-color: #1e1e1e;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  overflow-y: auto;
  overflow-x: hidden;
}

body, .app-container, .app-scale-wrapper {
  width: 100%;
  height: auto;
}

.app-scale-wrapper {
  display: flex;
  justify-content: center;
  align-items: stretch;
}

.app-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  box-sizing: border-box;
  padding-top: env(safe-area-inset-top, 0);
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.row {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  width: 100%;
  box-sizing: border-box;
  padding-left: calc(var(--gutter) + env(safe-area-inset-left, 0));
  padding-right: calc(var(--gutter) + env(safe-area-inset-right, 0));
}

h1 {
  font-size: clamp(24px, 5vw, 42px);
  margin: 6px 0 4px 0;
  font-weight: bold;
}

.slot-banner {
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.slot-banner img {
  max-height: 40px;
  width: auto;
  max-width: 100%;
  object-fit: contain;
}

h2 {
  font-size: clamp(22px, 4vw, 32px);
  margin: 0;
  padding: 0;
  line-height: 1;
  text-align: left;
  display: block;
}
.section-top    { margin-top: var(--space-top); }
.section-bottom { margin-bottom: var(--space-bottom); }

main.content {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.image-wrapper {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  position: relative;
  overflow: hidden;
  margin: 0;
  width: 100%;
}
.image-wrapper img {
  width: 100%;
  height: auto;
  object-fit: contain;
  object-position: center bottom;
  transition: opacity 0.3s ease-in-out;
}
.image-wrapper img.fade-out { opacity: 0; }
.image-wrapper img.fade-in { opacity: 1; }

.overlay {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  font-size: clamp(28px, 6vw, 50px);
  font-weight: bold;
  text-shadow: 0 0 15px rgba(0,0,0,0.9);
  pointer-events: none;
  animation: fadeout 0.8s ease-in forwards;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
@keyframes fadeout { 0%,80%{opacity:1;} 100%{opacity:0;} }

/* -------- Larger overlay text on mobile (browser + PWA) -------- */
@media screen and (max-width: 767px) {
  .overlay {
    font-size: clamp(34px, 8vw, 60px);   /* was 28–50px, now slightly bigger */
  }
}

/* -------- Button styles -------- */
.buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  flex: 0 0 auto;
  padding: 0;
  width: calc(100% - 14px);
  margin-left: 6px;
  box-sizing: border-box;
}
.buttons button {
  height: 36px;
  font-size: 16px;
  border-radius: 6px;
  background: #333;
  color: white;
  border: 2px solid #555;
  cursor: pointer;
  padding: 4px 0;
  white-space: normal;
  line-height: 1.1;
  word-break: keep-all;
}
.buttons button:hover { background:#444; }
.buttons button:active { background:#555; transform:scale(0.97); }

/* -------- PWA mode font -------- */
@media all and (display-mode: standalone) {
  .buttons button {
    height: 46px;
    font-size: 18px;
  }
}

/* -------- Desktop full-height fix -------- */
@media screen and (min-width: 768px) {
  html, body, .app-container, .app-scale-wrapper {
    height: 100vh;
  }
}

/* -------- Desktop button spacing -------- */
@media screen and (min-width: 768px) {
  .buttons {
    gap: 12px;
  }
  .buttons button {
    height: 82px;
    font-size: 24px;
  }
}

footer {
  flex: 0 0 auto;
  padding-bottom: calc(env(safe-area-inset-bottom,0) + 8px);
}
.progress-bar-container {
  background:#333;
  border-radius:10px;
  overflow:hidden;
  height:25px;
  width:102%;
  margin-bottom:8px;
  margin-left:-1%;
}
.progress-bar {
  height:100%;
  background:lime;
  width: {{ (progress/total*100) if total>0 else 0 }}%;
  transition:width 0.3s ease-in-out;
}
.progress-inline {
  font-weight:bold;
  margin-left:6px;
}

/* -------- Modal -------- */
.modal {
  display:{% if show_results %}flex{% else %}none{% endif %};
  position:fixed;
  inset:0;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-content {
  background:#2f2f2f;
  padding:clamp(20px,5vw,40px);
  border-radius:12px;
  text-align:center;
  width:clamp(240px,70%,330px);
  position:relative;
}
.modal-content h2{margin:0 0 15px 0;font-size:clamp(26px,6vw,38px);}
.modal-content p{font-size:clamp(20px,5vw,30px);margin:10px 0;}
.close-x {
  position:absolute;top:10px;right:18px;
  font-size:clamp(22px,6vw,30px);
  color:#aaa;font-weight:bold;cursor:pointer;
}
.close-x:hover{color:white;}

/* -------- Toggle styling -------- */
.toggle-group {
  display: inline-flex;
  justify-content: flex-start;
  align-items: center;
  background: #333;
  border: 2px solid #555;
  border-radius: 6px;
  overflow: hidden;
  width: fit-content;
  align-self: flex-start;
  margin-top: 4px;
  margin-bottom: 6px;
  margin-left: -4px;
}
.toggle-group label {
  flex: 1;
  padding: 6px 15px;
  cursor: pointer;
  font-weight: bold;
  font-size: clamp(22px, 4vw, 32px);
  color: #ccc;
  background: #333;
  transition: background 0.2s, color 0.2s;
}
.toggle-group input[type="radio"] {
  display: none;
}
.toggle-group input[type="radio"]:checked + label {
  background: #4caf50;
  color: white;
}
</style>
</head>

<body>
<div class="app-scale-wrapper">
  <div class="app-container">

    <header class="row">
      <h1>FS Randoms Trainer</h1>
    </header>

    <div class="row">
      <div class="slot-banner">
        <img src="{{ url_for('static', filename='slots.png') }}" alt="Slot Positions">
      </div>
    </div>

    <main class="content">
      <div class="row">
        <h2 class="section-top section-bottom">Formation</h2>
        <div class="image-wrapper" id="image-area">
          <img id="formation-image" src="data:image/png;base64,{{ img_data }}" alt="Formation">
          {% if msg %}
          <div id="overlay" class="overlay" style="color:{{ color }}">{{ msg }}</div>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <div class="toggle-group">
          <input type="radio" id="mode-letter" name="mode" value="Letter" checked>
          <label for="mode-letter">Letter</label>
          <input type="radio" id="mode-name" name="mode" value="Name">
          <label for="mode-name">Name</label>
        </div>
      </div>

      <form class="buttons row" id="GuessForm">
        {% for label in labels %}
        <button type="button" value="{{ label }}">{{ label }}</button>
        {% endfor %}
      </form>
    </main>

    <footer class="row">
      <h2 class="section-top section-bottom">
        Progress <span class="progress-inline">({{ progress }} of {{ total }})</span>
      </h2>
      <div class="progress-bar-container"><div class="progress-bar"></div></div>
    </footer>

  </div>
</div>

<div class="modal" id="resultsModal">
  <div class="modal-content">
    <span class="close-x" onclick="closeResults()">×</span>
    <h2>Results</h2>
    <p style="color:lime;">✅ Correct: {{ correct }}</p>
    <p style="color:red;">❌ Incorrect: {{ incorrect }}</p>
  </div>
</div>

<script>
let sequence = 0;

const NameMap = {
  A: "Unipod", B: "Stair Diam", C: "Mrphy Flak", D: "Yuan",
  E: "Meeker", F: "Open Accor", G: "Cataccord", H: "Bow",
  J: "Donut", K: "Hook", L: "Adder", M: "Star",
  N: "Crank", O: "Satellite", P: "Sidebody", Q: "Phalanx"
};

document.addEventListener("DOMContentLoaded", () => {
  const Img = document.getElementById("formation-image");
  const ProgInline = document.querySelector(".progress-inline");
  const ProgBar = document.querySelector(".progress-bar");
  const Buttons = document.querySelectorAll("#GuessForm button");
  const modeLetter = document.getElementById("mode-letter");
  const modeName = document.getElementById("mode-name");

  // each button's dataset initially equals its letter
  Buttons.forEach(btn => { btn.dataset.guess = btn.value; });

  function updateButtonLabels() {
    if (modeName.checked) {
      Buttons.forEach(btn => {
        const name = NameMap[btn.value];
        btn.textContent = name ? name : btn.value;
        btn.dataset.guess = name ? name : btn.value;
      });
    } else {
      Buttons.forEach(btn => {
        btn.textContent = btn.value;
        btn.dataset.guess = btn.value;
      });
    }
  }

  // Toggle events: update mode on server + update image
  modeLetter.addEventListener("change", () => {
    updateButtonLabels();
    fetch("/SetMode", { method: "POST", body: new URLSearchParams({ mode: "Letter" }) })
    .then(r => r.json()).then(({ img_data }) => {
      if (img_data) Img.src = "data:image/png;base64," + img_data;
    });
  });

  modeName.addEventListener("change", () => {
    updateButtonLabels();
    fetch("/SetMode", { method: "POST", body: new URLSearchParams({ mode: "Name" }) })
    .then(r => r.json()).then(({ img_data }) => {
      if (img_data) Img.src = "data:image/png;base64," + img_data;
    });
  });

  Buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const Guess = btn.dataset.guess;
      Buttons.forEach(b => b.disabled = true);
      const currentSeq = ++sequence;

      fetch("/Guess", { method: "POST", body: new URLSearchParams({ guess: Guess }) })
      .then(r => r.json()).then(data => {
        if (currentSeq !== sequence) return;
        if (ProgInline) ProgInline.textContent = `(${data.progress} of ${data.total})`;
        if (ProgBar) ProgBar.style.width = `${(data.progress / data.total) * 100}%`;

        if (data.done) {
          setTimeout(() => {
            if (currentSeq !== sequence) return;
            document.getElementById("resultsModal").style.display = "flex";
            const m = document.querySelector(".modal-content");
            m.querySelector("p:nth-child(3)").textContent = `✅ Correct: ${data.correct}`;
            m.querySelector("p:nth-child(4)").textContent = `❌ Incorrect: ${data.incorrect}`;
          }, 400);
          Buttons.forEach(b => b.disabled = false);
          return;
        }

        let overlay = document.getElementById("overlay");
        if (overlay) overlay.remove();
        overlay = document.createElement("div");
        overlay.id = "overlay";
        overlay.className = "overlay";
        overlay.style.color = data.color;
        overlay.textContent = data.msg;
        document.querySelector(".image-wrapper").appendChild(overlay);

        if (data.color !== "red") {
          const Delay = 800;
          setTimeout(() => {
            if (currentSeq !== sequence) return;
            Img.classList.add("fade-out");
            setTimeout(() => {
              if (currentSeq !== sequence) return;
              Img.src = "data:image/png;base64," + data.img_data;
              Img.onload = () => {
                Img.classList.remove("fade-out");
                Img.classList.add("fade-in");
                setTimeout(() => Img.classList.remove("fade-in"), 300);
              };
            }, 150);
          }, Delay);
        }
        setTimeout(() => Buttons.forEach(b => b.disabled = false), 900);
      }).catch(e => console.error("Error:", e));
    });
  });
});

function closeResults() {
  const currentSeq = ++sequence;
  fetch("/Reset", { method: "POST" }).then(r => r.json()).then(data => {
    if (currentSeq !== sequence) return;
    const Img = document.getElementById("formation-image");
    Img.src = "data:image/png;base64," + data.img_data;
    Img.classList.add("fade-in");
    setTimeout(() => Img.classList.remove("fade-in"), 300);
    const ProgInline = document.querySelector(".progress-inline");
    const ProgBar = document.querySelector(".progress-bar");
    ProgInline.textContent = `(${data.progress} of ${data.total})`;
    ProgBar.style.width = `${(data.progress / data.total) * 100}%`;
    document.getElementById("resultsModal").style.display = "none";
  }).catch(e => console.error("Error:", e));
}
</script>
</body>
</html>