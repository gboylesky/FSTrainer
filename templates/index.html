<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#1e1e1e">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<title>FS Randoms Trainer</title>

<style>
:root {
  --gutter: 10px;
  --space-top: 5px;
  --space-bottom: 5px;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  background-color: #1e1e1e;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  overflow-y: auto;
  overflow-x: hidden;
}

body, .app-container, .app-scale-wrapper {
  width: 100%;
  height: auto;
}

.app-scale-wrapper {
  display: flex;
  justify-content: center;
  align-items: stretch;
}

.app-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  box-sizing: border-box;
  padding-top: env(safe-area-inset-top, 0);
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.row {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  width: 100%;
  box-sizing: border-box;
  padding-left: calc(var(--gutter) + env(safe-area-inset-left, 0));
  padding-right: calc(var(--gutter) + env(safe-area-inset-right, 0));
}

h1 {
  font-size: clamp(24px, 5vw, 42px);
  margin: 6px 0 4px 0;
  font-weight: bold;
}

.slot-banner {
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.slot-banner img {
  max-height: 40px;
  width: auto;
  max-width: 100%;
  object-fit: contain;
}

/* -------- Headings (ensure left alignment) -------- */
h2 {
  font-size: clamp(22px, 4vw, 32px);
  margin: 0;
  padding: 0;
  line-height: 1;
  text-align: left;
  align-self: flex-start;
  display: block;
  width: 100%;
}
.section-top    { margin-top: var(--space-top); }
.section-bottom { margin-bottom: var(--space-bottom); }

/* -------- Category toggle (Randoms / Blocks) -------- */
.category-toggle {
  margin-top: 8px;
  margin-bottom: 8px;
  width: 100%;
  justify-content: center;
}
.category-toggle label {
  font-size: clamp(22px, 4vw, 32px);
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex: 1;
}
@media all and (display-mode: standalone) and (max-width: 767px) {
  .category-toggle label {
    height: 46px;
  }
}

main.content {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.image-wrapper {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  position: relative;
  overflow: hidden;
  margin: 0;
  width: 100%;
}
.image-wrapper img {
  width: 100%;
  height: auto;
  object-fit: contain;
  object-position: center bottom;
  transition: opacity 0.3s ease-in-out;
}
.image-wrapper img.fade-out { opacity: 0; }
.image-wrapper img.fade-in { opacity: 1; }

.overlay {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  font-size: clamp(28px, 6vw, 50px);
  font-weight: bold;
  text-shadow: 0 0 15px rgba(0,0,0,0.9);
  pointer-events: none;
  animation: fadeout 0.8s ease-in forwards;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
@keyframes fadeout { 0%,80%{opacity:1;} 100%{opacity:0;} }

@media screen and (max-width: 767px) {
  .overlay {
    font-size: clamp(42px, 10vw, 80px);
    text-shadow: 0 0 25px rgba(0,0,0,1);
  }
}

/* -------- Button styles -------- */
/* --- Unified alignment for button grid --- */
.buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  flex: 0 0 auto;
  width: 100%;
  margin: 0;
  box-sizing: border-box;
  padding-left: calc(var(--gutter) + env(safe-area-inset-left, 0));
  padding-right: calc(var(--gutter) + env(safe-area-inset-right, 0));
}
.buttons button {
  height: 36px;
  font-size: 16px;
  border-radius: 6px;
  background: #333;
  color: white;
  border: 2px solid #555;
  cursor: pointer;
  padding: 4px 0;
  white-space: normal;
  line-height: 1.1;
  word-break: keep-all;
}
.buttons button:hover { background:#444; }
.buttons button:active {
  background: #4caf50;       /* flash green when pressed */
  border-color: #4caf50;
  color: white;
  transform: scale(0.97);
}

/* --- Highlight the currently selected button in review mode (Test OFF) --- */
button.selected {
  background: #4caf50 !important;  /* same green as active toggles */
  color: white !important;          /* keep text white */
  border-color: #4caf50 !important;
  font-weight: bold;
}

/* Force Randoms/Blocks + Test to align horizontally */
.row.category-row {
  flex-direction: row !important;
  align-items: center;
  justify-content: space-between;
}

/* Force Letter/Name + No Hint to align horizontally */
.row.mode-row {
  flex-direction: row !important;
  align-items: center;
  justify-content: space-between;
}

/* -------- PWA mode font and truncation fix -------- */
@media all and (display-mode: standalone) {
  .buttons button {
    height: 36px;
    font-size: clamp(14px, 3.5vw, 16px); /* Slightly smaller */
    white-space: nowrap !important;
  }
}

/* -------- Desktop full-height fix -------- */
@media screen and (min-width: 768px) {
  html, body, .app-container, .app-scale-wrapper {
    height: 100vh;
  }
}

/* -------- Desktop button spacing -------- */
@media screen and (min-width: 768px) {
  .buttons {
    gap: 12px;
  }
  .buttons button {
    height: 82px;
    font-size: 24px;
  }
}

footer {
  flex: 0 0 auto;
  padding-bottom: calc(env(safe-area-inset-bottom,0) + 8px);
}
.progress-bar-container {
  background:#333;
  border-radius:10px;
  overflow:hidden;
  height:25px;
  width:102%;
  margin-bottom:8px;
  margin-left:-1%;
}
.progress-bar {
  height:100%;
  background:lime;
  width: {{ (progress/total*100) if total>0 else 0 }}%;
  transition:width 0.3s ease-in-out;
}
.progress-inline {
  font-weight:bold;
  margin-left:6px;
}

/* Smooth transition for greying out Progress heading */
#progressHeading[style*="opacity: 0.5"] {
  transition: opacity 0.2s ease;
}

/* -------- Modal -------- */
.modal {
  display:{% if show_results %}flex{% else %}none{% endif %};
  position:fixed;
  inset:0;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-content {
  background:#2f2f2f;
  padding:clamp(20px,5vw,40px);
  border-radius:12px;
  text-align:center;
  width:clamp(240px,70%,330px);
  position:relative;
}
.modal-content h2{margin:0 0 15px 0;font-size:clamp(26px,6vw,38px);}
.modal-content p{font-size:clamp(20px,5vw,30px);margin:10px 0;}
.close-x {
  position:absolute;top:10px;right:18px;
  font-size:clamp(22px,6vw,30px);
  color:#aaa;font-weight:bold;cursor:pointer;
}
.close-x:hover{color:white;}

/* -------- Toggle styling -------- */
.toggle-group {
  display: inline-flex;
  justify-content: flex-start;
  align-items: center;
  background: #333;
  border: 2px solid #555;
  border-radius: 6px;
  overflow: hidden;
  width: fit-content;
  align-self: flex-start;
  margin-top: 4px;
  margin-bottom: 6px;
  margin-left: -4px;
}
.toggle-group label {
  flex: 1;
  padding: 6px 15px;
  cursor: pointer;
  font-weight: bold;
  font-size: clamp(22px, 4vw, 32px);
  color: #ccc;
  background: #333;
  transition: background 0.2s, color 0.2s;
}
.toggle-group input[type="radio"] {
  display: none;
}
.toggle-group input[type="radio"]:checked + label {
  background: #4caf50;
  color: white;
}

/* -------- Inline layout for Letter/Name + No Hint -------- */
.mode-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}

.hint-toggle-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto;
}

.hint-toggle-inline .hint-label {
  font-size: clamp(18px, 3.5vw, 26px);
  font-weight: bold;
  color: #ccc;
  transition: color 0.3s ease-in-out;
}

/* Visually dim and block clicks when disabled */
#no-hint:disabled + .slider {
  opacity: 0.4;
  cursor: not-allowed;
  pointer-events: none;        /* <‚Äî blocks clicks on the slider */
}
#no-hint:disabled ~ #hint-label {
  opacity: 0.4;
  pointer-events: none;        /* <‚Äî blocks clicks on the label text */
}

/* -------- Inline layout for Randoms/Blocks + Test -------- */
.category-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}

/* -------- Consistent side alignment for all sections -------- */
.row,
.image-wrapper {
  padding-left: calc(var(--gutter) + env(safe-area-inset-left, 0));
  padding-right: calc(var(--gutter) + env(safe-area-inset-right, 0));
  box-sizing: border-box;
}

/* Make all rows align evenly (no extra margin offsets) */
.mode-row,
.category-row {
  margin-left: 0;
  margin-right: 0;
}

/* Keep toggle group properly aligned within its row */
.toggle-group {
  margin-left: 0;
}

/* Make the label turn green when active */
.hint-toggle-inline input:checked ~ .hint-label {
  color: #4caf50;
}

/* Adjust switch size for consistency */
.hint-toggle-inline .switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 26px;
}
.hint-toggle-inline .switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.hint-toggle-inline .slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #555;
  transition: 0.3s;
  border-radius: 26px;
}
.hint-toggle-inline .slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
.hint-toggle-inline .switch input:checked + .slider {
  background-color: #4caf50;
}
.hint-toggle-inline .switch input:checked + .slider:before {
  transform: translateX(20px);
}

/* --- FINAL FIX: Force Randoms/Blocks toggle to match Letter/Name --- */
.toggle-group.category-toggle label {
  height: 20px !important; /* default browser */
}

/* PWA mode */
@media all and (display-mode: standalone) {
  .toggle-group.category-toggle label {
    height: 26px !important;
    font-size: 22px !important;
  }
}

/* Desktop mode */
@media screen and (min-width: 768px) {
  .toggle-group.category-toggle label {
    height: 42px !important;
    font-size: 30px !important;
  }
}

/* Fully lock the grid when class .locked is applied */
#GuessForm.locked {
  pointer-events: none !important;
  opacity: 0.6;              /* optional dimming to show it's inactive */
  transition: opacity 0.2s ease;
}
</style>
</head>

<body>
<div class="app-scale-wrapper">
  <div class="app-container">

    <header class="row">
      <h1>FS Randoms Trainer</h1>
    </header>

    <div class="row">
      <div class="slot-banner">
        <img src="{{ url_for('static', filename='slots.png') }}" alt="Slot Positions">
      </div>
    </div>

    <main class="content">
      <div class="row category-row">
        <div class="toggle-group category-toggle">
          <input type="radio" id="cat-randoms" name="category" value="Randoms" checked>
          <label for="cat-randoms">Randoms</label>
          <input type="radio" id="cat-blocks" name="category" value="Blocks">
          <label for="cat-blocks">Blocks</label>
        </div>

        <div class="hint-toggle-inline">
          <label class="switch">
            <input type="checkbox" id="test-mode">
            <span class="slider"></span>
          </label>
          <span class="hint-label" id="test-label">Test</span>
        </div>
      </div>

      <div class="image-wrapper" id="image-area">
        <img id="formation-image" src="data:image/png;base64,{{ img_data }}" alt="Formation">
        {% if msg %}
        <div id="overlay" class="overlay" style="color:{{ color }}">{{ msg }}</div>
        {% endif %}
      </div>

      <div class="row mode-row">
        <div class="toggle-group">
          <input type="radio" id="mode-letter" name="mode" value="Letter" checked>
          <label for="mode-letter">Letter</label>
          <input type="radio" id="mode-name" name="mode" value="Name">
          <label for="mode-name">Name</label>
        </div>

        <div class="hint-toggle-inline">
          <label class="switch">
            <input type="checkbox" id="no-hint">
            <span class="slider"></span>
          </label>
          <span class="hint-label" id="hint-label">No Hint</span>
        </div>
      </div>

      <form class="buttons row" id="GuessForm">
        {% for label in labels %}
        <button type="button" value="{{ label }}">{{ label }}</button>
        {% endfor %}
      </form>
    </main>

    <footer class="row">
      <h2 id="progressHeading" class="section-top section-bottom">
        Progress <span class="progress-inline">({{ progress }} of {{ total }})</span>
      </h2>
      <div class="progress-bar-container"><div class="progress-bar"></div></div>
    </footer>

  </div>
</div>

<div class="modal" id="resultsModal">
  <div class="modal-content">
    <span class="close-x" onclick="closeResults()">√ó</span>
    <h2>Results</h2>
    <p style="color:lime;">‚úÖ Correct: {{ correct }}</p>
    <p style="color:red;">‚ùå Incorrect: {{ incorrect }}</p>
  </div>
</div>

<script>
let sequence = 0;

function setGridLocked(state) {
  const grid = document.getElementById("GuessForm");
  if (state) grid.classList.add("locked");
  else grid.classList.remove("locked");
}

const NameMap = {
  A: "Unipod", B: "Stair Diam", C: "Mrphy Flak", D: "Yuan",
  E: "Meeker", F: "Open Accor", G: "Cataccord", H: "Bow",
  J: "Donut", K: "Hook", L: "Adder", M: "Star",
  N: "Crank", O: "Satellite", P: "Sidebody", Q: "Phalanx"
};

document.addEventListener("DOMContentLoaded", () => {
  const Img = document.getElementById("formation-image");
  const ProgInline = document.querySelector(".progress-inline");
  const ProgBar = document.querySelector(".progress-bar");
  const Buttons = document.querySelectorAll("#GuessForm button");
  const modeLetter = document.getElementById("mode-letter");
  const modeName = document.getElementById("mode-name");
  const appTitle = document.querySelector("h1");
  const catRandoms = document.getElementById("cat-randoms");
  const catBlocks = document.getElementById("cat-blocks");
  // --- Test slider handler (works in browser + PWA) ---   
  const testToggle = document.getElementById("test-mode");
  const testLabel = document.getElementById("test-label");

  function updateTestModeState() {
    const isTestMode = testToggle.checked;
    fetch("/SetTestMode", {
      method: "POST",
      cache: "no-store",
      body: new URLSearchParams({ test_mode: isTestMode })
    })
    .then(r => r.json())
    .then(({ success }) => {
      console.log("Test mode:", success ? (isTestMode ? "ON" : "OFF") : "FAILED");
    })
    .catch(e => console.error("Error toggling Test mode:", e));
  }

  testToggle.addEventListener("click", updateTestModeState);
  testToggle.addEventListener("change", updateTestModeState);

  function updateNoHintAvailability() {
    const noHintToggle = document.getElementById("no-hint");
    const hintLabel = document.getElementById("hint-label");
    const testToggle = document.getElementById("test-mode");

    if (!testToggle.checked) {
      // Turn off No Hint when Test is deselected
      if (noHintToggle.checked) {
        noHintToggle.checked = false;

        // Tell backend to switch NoHint off
        fetch("/SetNoHint", {
          method: "POST",
          cache: "no-store",
          body: new URLSearchParams({ no_hint: false })
        })
        .then(r => r.json())
        .then(({ img_data }) => {
          // Refresh the image according to the current Letter/Name mode
          if (img_data && img_data.length > 0) {
            const Img = document.getElementById("formation-image");
            Img.classList.add("fade-out");
            setTimeout(() => {
              Img.src = "data:image/png;base64," + img_data;
              Img.onload = () => {
                Img.classList.remove("fade-out");
                Img.classList.add("fade-in");
                setTimeout(() => Img.classList.remove("fade-in"), 300);
              };
            }, 150);
          }
        })
        .catch(e => console.error("Error resetting No Hint:", e));
      }

      // Disable No Hint slider visually
      noHintToggle.disabled = true;
      hintLabel.style.opacity = "0.5";
      hintLabel.style.pointerEvents = "none";
    } else {
      // Enable No Hint when Test is active
      noHintToggle.disabled = false;
      hintLabel.style.opacity = "1";
      hintLabel.style.pointerEvents = "auto";
    }
  }

  testToggle.addEventListener("change", () => {
    const isTestMode = testToggle.checked;
    updateTestModeState();
    updateNoHintAvailability();

    if (isTestMode) {
      // --- TEST MODE ACTIVATED ---
      // Clear all button highlights
      Buttons.forEach(b => b.classList.remove("selected"));

      // Fetch a new random image (same as app startup in Test mode)
      fetch("/Reset", { method: "POST" })
        .then(r => r.json())
        .then(data => {
          if (data.img_data) {
            Img.classList.add("fade-out");
            setTimeout(() => {
              Img.src = "data:image/png;base64," + data.img_data;
              Img.onload = () => {
                Img.classList.remove("fade-out");
                Img.classList.add("fade-in");
                setTimeout(() => Img.classList.remove("fade-in"), 300);
              };
            }, 150);
          }
          // Reset progress display
          if (ProgInline) ProgInline.textContent = `(${data.progress} of ${data.total})`;
          if (ProgBar) ProgBar.style.width = `${(data.progress / data.total) * 100}%`;
        })
        .catch(e => console.error("Error resetting for Test mode:", e));

    } else {
      // --- REVIEW MODE ACTIVATED ---
      // Default back to A.png and highlight A
      const firstBtn = document.querySelector('#GuessForm button[value="A"]');
      Buttons.forEach(b => b.classList.remove("selected"));
      if (firstBtn) {
        firstBtn.classList.add("selected");
        const mode = modeLetter.checked ? "Letter" : "Name";
        const folder = mode === "Letter" ? "Letter" : "Name";
        Img.classList.add("fade-out");
        setTimeout(() => {
          Img.src = `/static/Randoms/${folder}/A.png`;
          Img.onload = () => {
            Img.classList.remove("fade-out");
            Img.classList.add("fade-in");
            setTimeout(() => Img.classList.remove("fade-in"), 300);
          };
        }, 150);
      }

      // Reset progress and grey out heading
      ProgInline.textContent = "(0 of 16)";
      ProgBar.style.width = "0%";
      const progressHeading = document.getElementById("progressHeading");
      progressHeading.style.opacity = "0.6";
      progressHeading.style.color = "#888";
    }
  });

  // --- No Hint slider handler (works in browser + PWA) ---
  const noHintToggle = document.getElementById("no-hint");
  const hintLabel = document.getElementById("hint-label");

  function updateNoHintState() {
    const isNoHint = noHintToggle.checked;

    fetch("/SetNoHint", {
      method: "POST",
      cache: "no-store",        // <-- ADD THIS LINE
      body: new URLSearchParams({ no_hint: isNoHint })
    })
    .then(r => r.json())
    .then(({ img_data }) => {
      const Img = document.getElementById("formation-image");
      if (img_data && img_data.length > 0) {
        Img.classList.add("fade-out");
        setTimeout(() => {
          Img.src = "data:image/png;base64," + img_data;
          Img.onload = () => {
            Img.classList.remove("fade-out");
            Img.classList.add("fade-in");
            setTimeout(() => Img.classList.remove("fade-in"), 300);
          };
        }, 150);
      } else {
        console.warn("‚ö†Ô∏è No image returned from /SetNoHint");
      }
    })
    .catch(e => console.error("Error toggling No Hint:", e));
  }

  // Attach both events to make it reliable on all devices
  noHintToggle.addEventListener("click", updateNoHintState);
  noHintToggle.addEventListener("change", updateNoHintState);

  // --- Enable/Disable NoHint slider  ---
  updateNoHintAvailability();

  // --- Default state on app load ---
  if (!testToggle.checked) {
    const firstBtn = document.querySelector('#GuessForm button[value="A"]');
    if (firstBtn) {
      firstBtn.classList.add("selected");
      const mode = modeLetter.checked ? "Letter" : "Name";
      const folder = mode === "Letter" ? "Letter" : "Name";
      Img.src = `/static/Randoms/${folder}/A.png`;
    }
  }

  Buttons.forEach(btn => { btn.dataset.guess = btn.value; });

  function updateButtonLabels() {
    if (modeName.checked) {
      Buttons.forEach(btn => {
        const name = NameMap[btn.value];
        btn.textContent = name ? name : btn.value;
        btn.dataset.guess = name ? name : btn.value;
      });
    } else {
      Buttons.forEach(btn => {
        btn.textContent = btn.value;
        btn.dataset.guess = btn.value;
      });
    }
  }

  function updateAppTitle() {
    if (catBlocks.checked) {
      appTitle.textContent = "FS Blocks Trainer";
    } else {
      appTitle.textContent = "FS Randoms Trainer";
    }
  }

  catRandoms.addEventListener("change", () => {
    updateAppTitle();
    fetch("/SetCategory", { method: "POST", body: new URLSearchParams({ category: "Randoms" }) });
  });
  catBlocks.addEventListener("change", () => {
    updateAppTitle();
    fetch("/SetCategory", { method: "POST", body: new URLSearchParams({ category: "Blocks" }) });
  });

  modeLetter.addEventListener("change", () => {
    updateButtonLabels();
    fetch("/SetMode", { method: "POST", body: new URLSearchParams({ mode: "Letter" }) })
    .then(r => r.json()).then(({ img_data }) => {
      if (img_data) Img.src = "data:image/png;base64," + img_data;
    });
  });

  modeName.addEventListener("change", () => {
    updateButtonLabels();
    fetch("/SetMode", { method: "POST", body: new URLSearchParams({ mode: "Name" }) })
    .then(r => r.json()).then(({ img_data }) => {
      if (img_data) Img.src = "data:image/png;base64," + img_data;
    });
  });

 // --- New button grid lock functionality --// 
Buttons.forEach(btn => {
  btn.addEventListener("click", () => {
    const Guess = btn.dataset.guess;
    const isTestMode = document.getElementById("test-mode").checked;
    const Img = document.getElementById("formation-image");
    const modeLetter = document.getElementById("mode-letter");

    // üîí Immediately lock the grid visually
    setGridLocked(true);

    // === REVIEW MODE (Test OFF) ===
    if (!isTestMode) {
      Buttons.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");

      const mode = modeLetter.checked ? "Letter" : "Name";
      const folder = mode === "Letter" ? "Letter" : "Name";
      const newSrc = `/static/Randoms/${folder}/${btn.value}.png`;

      Img.classList.add("fade-out");
      setTimeout(() => {
        Img.src = newSrc;
        Img.onload = () => {
          Img.classList.remove("fade-out");
          Img.classList.add("fade-in");
          setTimeout(() => Img.classList.remove("fade-in"), 300);

          // üîì Unlock grid only after image fully loads
          setTimeout(() => setGridLocked(false), 300);
        };
      }, 100);

      return;
    }

    // === TEST MODE ===
    const currentSeq = ++sequence;
    fetch("/Guess", { method: "POST", body: new URLSearchParams({ guess: Guess }) })
      .then(r => r.json())
      .then(data => {
        if (currentSeq !== sequence) return;

        if (ProgInline) ProgInline.textContent = `(${data.progress} of ${data.total})`;
        if (ProgBar) ProgBar.style.width = `${(data.progress / data.total) * 100}%`;

        // Create overlay
        let overlay = document.getElementById("overlay");
        if (overlay) overlay.remove();
        overlay = document.createElement("div");
        overlay.id = "overlay";
        overlay.className = "overlay";
        overlay.style.color = data.color;
        overlay.textContent = data.msg;
        document.querySelector(".image-wrapper").appendChild(overlay);

        // ‚úÖ If correct ‚Üí wait for overlay to fade, then change image and unlock after image load
        if (data.color !== "red") {
          const Delay = 800; // overlay fade duration
          setTimeout(() => {
            if (currentSeq !== sequence) return;
            Img.classList.add("fade-out");
            setTimeout(() => {
              if (currentSeq !== sequence) return;
              Img.src = "data:image/png;base64," + data.img_data;
              Img.onload = () => {
                Img.classList.remove("fade-out");
                Img.classList.add("fade-in");
                setTimeout(() => Img.classList.remove("fade-in"), 300);

                // üîì Unlock grid after image transition completes
                setTimeout(() => setGridLocked(false), 300);
              };
            }, 150);
          }, Delay);
        } else {
          // ‚ùå Wrong answer ‚Üí wait for overlay to finish before unlocking
          setTimeout(() => setGridLocked(false), 800);
        }

        // End of Test mode logic
      })
      .catch(e => {
        console.error("Error:", e);
        setGridLocked(false);
      });
  });
});

function closeResults() {
  const currentSeq = ++sequence;
  fetch("/Reset", { method: "POST" }).then(r => r.json()).then(data => {
    if (currentSeq !== sequence) return;
    const Img = document.getElementById("formation-image");
    Img.src = "data:image/png;base64," + data.img_data;
    Img.classList.add("fade-in");
    setTimeout(() => Img.classList.remove("fade-in"), 300);
    const ProgInline = document.querySelector(".progress-inline");
    const ProgBar = document.querySelector(".progress-bar");
    ProgInline.textContent = `(${data.progress} of ${data.total})`;
    ProgBar.style.width = `${(data.progress / data.total) * 100}%`;
    document.getElementById("resultsModal").style.display = "none";
  }).catch(e => console.error("Error:", e));
}
</script>
</body>
</html>