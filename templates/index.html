<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#1e1e1e">
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<title>FS Randoms Trainer</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  background-color: #1e1e1e;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  overflow: hidden;
}

/* --------- Layout wrappers --------- */
.app-scale-wrapper {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: stretch;
}

.app-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
  margin: 0;
  box-sizing: border-box;
  padding: env(safe-area-inset-top,0) env(safe-area-inset-right,0)
           env(safe-area-inset-bottom,0) env(safe-area-inset-left,0);
  max-width: 480px;
}

@media (min-width: 901px) {
  .app-container { margin: 0 auto; }
}

/* --------- Header --------- */
h1 {
  font-size: clamp(24px, 5vw, 42px);
  margin: 16px 0 8px 0;
  font-weight: bold;
}

.slot-banner {
  width: 100%;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 10px;
}
.slot-banner img {
  height: 100%;
  object-fit: contain;
}

/* --------- Main content --------- */
main.content {
  flex: 1 1 auto;              /* fills available height */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  overflow: hidden;
}

h2 {
  font-size: clamp(22px, 4vw, 32px);
  margin: 6px 10px;
  text-align: left;
}

/* --------- Image area --------- */
.image-wrapper {
  flex: 1 1 auto;              /* grow to fill */
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 10px;
  position: relative;
  overflow: hidden;
}
.image-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transition: opacity 0.3s ease-in-out;
}
.image-wrapper img.fade-out { opacity: 0; }
.image-wrapper img.fade-in { opacity: 1; }

.overlay {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  font-size: clamp(40px, 8vw, 70px);
  font-weight: bold;
  text-shadow: 0 0 15px rgba(0,0,0,0.9);
  pointer-events: none;
  animation: fadeout 0.8s ease-in forwards;
}
@keyframes fadeout { 0%,80%{opacity:1;} 100%{opacity:0;} }

/* --------- Buttons --------- */
.buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  padding: 10px;
  flex: 0 0 auto;             /* fixed height region */
}
.buttons button {
  font-size: 20px;
  padding: 10px 6px;
  border-radius: 8px;
  background: #333;
  color: white;
  border: 2px solid #555;
  cursor: pointer;
}
.buttons button:hover { background:#444; }
.buttons button:active { background:#555; transform:scale(0.97); }

/* --------- Footer --------- */
footer {
  flex: 0 0 auto;
  padding: 0 10px calc(env(safe-area-inset-bottom,0) + 8px);
}
.progress-bar-container {
  background:#333;
  border-radius:10px;
  overflow:hidden;
  height:25px;
  width:100%;
  margin-bottom:8px;
}
.progress-bar {
  height:100%;
  background:lime;
  width: {{ (progress/total*100) if total>0 else 0 }}%;
  transition:width 0.3s ease-in-out;
}
.progress-inline {
  font-weight:bold;
  margin-left:6px;
}

/* --------- Modal --------- */
.modal {
  display:{% if show_results %}flex{% else %}none{% endif %};
  position:fixed;
  inset:0;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-content {
  background:#2f2f2f;
  padding:clamp(20px,5vw,40px);
  border-radius:12px;
  text-align:center;
  width:clamp(240px,70%,330px);
  position:relative;
}
.modal-content h2{margin:0 0 15px 0;font-size:clamp(26px,6vw,38px);}
.modal-content p{font-size:clamp(20px,5vw,30px);margin:10px 0;}
.close-x {
  position:absolute;top:10px;right:18px;
  font-size:clamp(22px,6vw,30px);
  color:#aaa;font-weight:bold;cursor:pointer;
}
.close-x:hover{color:white;}
</style>
</head>

<body>
<div class="app-scale-wrapper">
  <div class="app-container">
    <header>
      <h1>FS Randoms Trainer</h1>
      <div class="slot-banner">
        <img src="{{ url_for('static', filename='slots.png') }}" alt="Slot Positions">
      </div>
    </header>

    <main class="content">
      <h2>Formation</h2>
      <div class="image-wrapper" id="image-area">
        <img id="formation-image" src="data:image/png;base64,{{ img_data }}" alt="Formation">
        {% if msg %}
        <div id="overlay" class="overlay" style="color:{{ color }}">{{ msg }}</div>
        {% endif %}
      </div>

      <h2>Letter</h2>
      <form class="buttons" id="GuessForm">
        {% for label in labels %}
        <button type="button" value="{{ label }}">{{ label }}</button>
        {% endfor %}
      </form>
    </main>

    <footer>
      <h2>Progress <span class="progress-inline">({{ progress }} of {{ total }})</span></h2>
      <div class="progress-bar-container"><div class="progress-bar"></div></div>
    </footer>
  </div>
</div>

<div class="modal" id="resultsModal">
  <div class="modal-content">
    <span class="close-x" onclick="closeResults()">×</span>
    <h2>Results</h2>
    <p style="color:lime;">✅ Correct: {{ correct }}</p>
    <p style="color:red;">❌ Incorrect: {{ incorrect }}</p>
  </div>
</div>

<script>
let sequence=0;
document.addEventListener("DOMContentLoaded",()=>{
  const Img=document.getElementById("formation-image");
  const ProgInline=document.querySelector(".progress-inline");
  const ProgBar=document.querySelector(".progress-bar");
  const Buttons=document.querySelectorAll("#GuessForm button");

  Buttons.forEach(btn=>{
    btn.addEventListener("click",()=>{
      const Guess=btn.value;
      Buttons.forEach(b=>b.disabled=true);
      const currentSeq=++sequence;

      fetch("/Guess",{method:"POST",body:new URLSearchParams({guess:Guess})})
      .then(r=>r.json()).then(data=>{
        if(currentSeq!==sequence)return;
        if(ProgInline)ProgInline.textContent=`(${data.progress} of ${data.total})`;
        if(ProgBar)ProgBar.style.width=`${(data.progress/data.total)*100}%`;

        if(data.done){
          setTimeout(()=>{
            if(currentSeq!==sequence)return;
            document.getElementById("resultsModal").style.display="flex";
            const m=document.querySelector(".modal-content");
            m.querySelector("p:nth-child(3)").textContent=`✅ Correct: ${data.correct}`;
            m.querySelector("p:nth-child(4)").textContent=`❌ Incorrect: ${data.incorrect}`;
          },400);
          Buttons.forEach(b=>b.disabled=false);
          return;
        }

        let overlay=document.getElementById("overlay");
        if(overlay)overlay.remove();
        overlay=document.createElement("div");
        overlay.id="overlay";overlay.className="overlay";
        overlay.style.color=data.color;overlay.textContent=data.msg;
        document.querySelector(".image-wrapper").appendChild(overlay);

        if(data.color!=="red"){
          const Delay=800;
          setTimeout(()=>{
            if(currentSeq!==sequence)return;
            Img.classList.add("fade-out");
            setTimeout(()=>{
              if(currentSeq!==sequence)return;
              Img.src="data:image/png;base64,"+data.img_data;
              Img.onload=()=>{Img.classList.remove("fade-out");Img.classList.add("fade-in");
                setTimeout(()=>Img.classList.remove("fade-in"),300);};
            },150);
          },Delay);
        }
        setTimeout(()=>Buttons.forEach(b=>b.disabled=false),900);
      }).catch(e=>console.error("Error:",e));
    });
  });
});

function closeResults(){
  const currentSeq=++sequence;
  fetch("/Reset",{method:"POST"}).then(r=>r.json()).then(data=>{
    if(currentSeq!==sequence)return;
    const Img=document.getElementById("formation-image");
    Img.src="data:image/png;base64,"+data.img_data;
    Img.classList.add("fade-in");setTimeout(()=>Img.classList.remove("fade-in"),300);
    const ProgInline=document.querySelector(".progress-inline");
    const ProgBar=document.querySelector(".progress-bar");
    ProgInline.textContent=`(${data.progress} of ${data.total})`;
    ProgBar.style.width=`${(data.progress/data.total)*100}%`;
    document.getElementById("resultsModal").style.display="none";
  }).catch(e=>console.error("Error:",e));
}
</script>
</body>
</html>